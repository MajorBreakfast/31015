\section{Implementation}
Our implementation consists of a realtime linux desktop machine, handling the localisation and control logic, and a microcontroller
positioned on the arm. The microcontroller handles measurements from the MEMs accelerometer and rate gyroscope as well as the ultrasound
distance sensor. The IR distance sensor is connected directly to the desktop machine through a National Instruments ADC/DAC, as is the 
potentiometer at the base of the arm which is used for reference measurements.

We have made several changes to the original setup by Hermansen. The most important of these are

\begin{itemize}
		\item A complete overhaul of the communications subsystem in order to support sending accelerometer, rate gyroscope and 
			distance measurements at 1kHz and avoid intermittent transmission errors. 
		\item The original complementary filter has been replaced by a static kalman filter for state estimation and a linear 
			quadratic regulator for motor command control.
			\item An ultrasound sensor has been added to the arm for distance measurements.
\end{itemize}

The microcontroller on the arm is an ARMÂ® Cortex M4F mounted on a Tiva Launchpad development board.
It is connected to an MPU9150 on which the MEMs accelerometer and rate gyroscope resides.

\subsection{Communications subsystem}
The Tiva Launcpad recieves measurements from the accelerometer, rate gyroscope and ultrasound sensor. The accelerometer and 
rate gyroscope is sampled at 1kHz, while the ultrasound sensor has a varying sample rate that depends on the distance to the nearest
object. The measurement data is transformed into a packet where the leading bit of every byte contains a synchronization bit. When
the bit is set it signifies the start of a packet. These packets are then sent to the desktop machine at 1kHz. When the ultrasound 
sensor is not ready with a new measurement, zeroes are transmitted. The packets are received on the desktop machine, which is 
running a control loop at 200Hz. Here the packets are unpacked to their original form and corrupted packets are thrown away.
\subsection{Localisation}
Our localisation algorithm is a three step process. First the rate gyroscpoe measurements are used to determine the orientation of
the arm. This is done using the Madgwick AHRS system\cite{Madgwick2011}. It is necessary to know the orientation of the arm before
the acceleration can be calculated because the acceleration measured by the tri-axis MEMs accelerometer is relative to the 
accelerometer frame. Additionally, gravity results in an offset in the accelerometer measurements that has constant magnitude, but
orientation varying with the orientation of the accelerometer. The acceleration is then rotated into earth frame and the vertical
acceleration is isolated since we only care about the height of the arm.
This is then used as the control input to a static multi rate kalman filter.

The kalman filter executes a predict step for every measurement coming from the accelerometer at 1kHz and an update step as soon 
as a measurement is received from the distance sensor, be it ultrasound or infrared, at \(\sim\)30Hz. We use the state space 
vector where the acceleration, velocity and position are perpendicular to the ground.
\begin{equation*}
	\hat{\mathbf{x}} = \begin{bmatrix}
		a_{off} \\
		v \\
		x
	\end{bmatrix}
\end{equation*}
Where \(a_{off}\) is the acceleration offset.
The state transition model where \(T\) is the sample period for the accelerometer.
\begin{equation*}
	\mathbf{F} = \begin{bmatrix}
		1 & 0 & 0 \\
		T & 1 & 0 \\
		0 & T & 1 
	\end{bmatrix}
\end{equation*}
And control input model, where the control input is actually the acceleration.
\begin{equation*}
	B = \begin{bmatrix}
		0 \\
		T \\
		0 
	\end{bmatrix}
\end{equation*}

\subsection{Controller}
